---
title: "La grandeza de Kobe Bryant II: selección de tiros"
output: html_notebook
---

Tras el fallecimiento de Kobe Bryant me comprometí a postear una serie de entradas relacionadas a él. En esta oportunidad haremos un análisis exploratorio de Kobe Bryant desde la optica de los tiros que tomó en su 20 años de carrera profesional.

La data que usaremos para este análisis es una publicada en [kaggle](https://www.kaggle.com/) para una competencia de machine learning. El objetivo de la competencia es utilizar un set de los tiros tomados por Kobe y construir un modelo que clasifique si una serie de observaciones, para las cuales no tenemos el resultado, fueron encestados o no. 

Entre las variables que constituyen el set de datos se encuentran las siguientes:

- Ubicación del tiro, con coordenadas en escala a las dimensiones de una chancha de basket.
- Zona del tiro
- Distancia respecto al aro
- Tiempo restante en el relog de 24 seg y en el juego
- Tipo de tiro ()
- Id del juego
- Equipo contrincante
- Si el tiro se tomó en playoff o serie regular
- Fecha del juego
- Resultado del lanzamiento (acierto o fallo)

Todas estas son variables útiles pero, en general, la habilidad anotadora de un jugador y el contexto de un tiro no se puede analizar completamente con este tipo de data, aunque sin dudas permite construir una visión interesante sobre el jugador. 








```{r}
train %>%
  group_by(season = parse_number(season)) %>% 
  summarise(fg_percent = mean(shot_made_flag),
            tiros = n()) %>% 
  ggplot(aes(x = season, y = fg_percent)) +
  geom_line() +
  geom_point(aes(size = tiros)) +
  scale_y_continuous(labels = scales::percent) +
  coord_cartesian(ylim = c(0.2, 0.50)) +
  theme_minimal() +
  theme(
    legend.position = "bottom"
  )
  

```







```{r, fig.width=10}
shot_zone <- shots_data %>% 
  filter(shot_zone_basic != "Backcourt") %>% 
  ggplot() +
  geom_point(aes(x = loc_x/10, y = (loc_y + 50)/10, color = shot_zone_basic), show.legend = FALSE) +
   geom_path(
    data = court_points,
    aes(x = x, y = y, group = desc)
  ) +
  theme(
    axis.text = 
  ) +
  theme_void() +
  theme(legend.position = "right") +
  labs() +
   scale_color_brewer(palette = "Spectral")


shots_data %>% 
  filter(shot_zone_basic != "Backcourt") %>% 
  group_by(shot_zone_basic) %>% 
  summarise(
    tiros = n(),
    porcentaje = mean(shot_made_flag, na.rm = TRUE)
  ) %>% 
  gather(medida, valor, -shot_zone_basic) %>%
  mutate(
    medida = factor(medida, labels = c("Porcentaje de tiro", "Cantidad de tiros"))
  ) %>% 
  ggplot(aes(
    x = tidytext::reorder_within(shot_zone_basic, desc(valor), medida),
    y = valor,
    fill = shot_zone_basic)) +
  geom_col(show.legend = FALSE, alpha = 0.7) +
  facet_wrap(~medida, scales = "free") +
  tidytext::scale_x_reordered() +
  coord_flip() +
  annotation_custom(ggplotGrob(shot_zone), xmin = 4, xmax = 6, ymin = 6500, ymax = 12000) +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma) +
  theme(
    strip.text = element_text(size = 12, face = "bold")
  ) +
  labs(x = "",
       y = "") +
   scale_fill_brewer(palette = "Spectral")
```

```{r fig.width=10}
shot_zone2 <- shots_data %>% 
  filter(shot_zone_area != "Back Court(BC)") %>% 
  ggplot() +
  geom_point(aes(x = loc_x/10, y = (loc_y + 50)/10, color = shot_zone_area), show.legend = FALSE) +
   geom_path(
    data = court_points,
    aes(x = x, y = y, group = desc)
  ) +
  theme(
    axis.text = 
  ) +
  theme_void() +
  theme(legend.position = "right") +
  labs() +
   scale_color_brewer(palette = "Spectral")


shots_data %>% 
  filter(shot_zone_area != "Back Court(BC)") %>% 
  group_by(shot_zone_area) %>% 
  summarise(
    tiros = n(),
    porcentaje = mean(shot_made_flag, na.rm = TRUE)
  ) %>% 
  gather(medida, valor, -shot_zone_area) %>%
  mutate(
    medida = factor(medida, labels = c("Porcentaje de tiro", "Cantidad de tiros"))
  ) %>% 
  ggplot(aes(
    x = tidytext::reorder_within(shot_zone_area, desc(valor), medida),
    y = valor,
    fill = shot_zone_area)) +
  geom_col(show.legend = FALSE, alpha = 0.7) +
  facet_wrap(~medida, scales = "free") +
  tidytext::scale_x_reordered() +
  coord_flip() +
  annotation_custom(ggplotGrob(shot_zone2), xmin = 3.8, xmax = 5.5, ymin = 6500, ymax = 12000) +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma) +
  theme(
    strip.text = element_text(size = 12, face = "bold")
  ) +
  labs(x = "",
       y = "") +
   scale_fill_brewer(palette = "Spectral")
```





```{r}
train %>% 
  filter(shot_zone_basic != "Backcourt") %>% 
  ggplot(aes(x = loc_x/10, y = (loc_y/10)+5)) +
  geom_point(alpha = 0.5, size = 0.5) +
  geom_path(
    data = court_points,
    aes(x = x, y = y, group = desc)
  ) +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  ) +
  coord_cartesian(expand = FALSE)
  
```

  
  
```{r}
train %>% 
  filter(combined_shot_type == "Jump Shot", shot_zone_basic != "Backcourt") %>% 
  ggplot() +
        stat_density2d(
          geom = 'polygon',
          contour = T, n = 500,
          aes(x = loc_x/10,
              y = (loc_y + 50)/10,
              color = factor(shot_made_flag, levels = c(0, 1), labels = c("Fallados", "Anotados")),
              fill = ..level..,
              alpha = ..level..)
          ) +
  geom_path(
    data = court_points,
    aes(x = x, y = y, group = desc)
  ) +
  guides(alpha = FALSE, color = FALSE) +
  facet_wrap(~factor(shot_made_flag, levels = c(0, 1), labels = c("Fallados", "Anotados"))) +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    strip.text = element_text(size = 12),
    legend.position = "bottom"
  ) +
  scale_fill_viridis_c()
```

```{r}
train %>% 
  filter(combined_shot_type == "Jump Shot", shot_zone_basic != "Backcourt",
         season %in% c("1999-00", "2000-01", "2001-02", "2008-09", "2009-10")) %>%
  ggplot() +
        stat_density2d(
          aes(x = loc_x/10,
              y = (loc_y + 50)/10,
              fill = stat(density/ max(density))),
          geom = "raster",
          contour = FALSE,
          interpolate = TRUE,
          n = 50
          ) +
  geom_path(
    data = court_points,
    aes(x = x, y = y, group = desc),
    color = "white"
  ) +
  scale_fill_viridis_c(
      "Frecuencia",
      limits = c(0, 1),
      breaks = c(0, 0.5, 1),
      labels = c("baja", "media", "alta"),
      option = "magma",
      guide = guide_colorbar(barwidth = 10)
    )  +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    strip.text = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_cartesian(expand = FALSE)
  
```

```{r}
train %>% 
  filter(combined_shot_type %in% c("Bank Shot", "Hook Shot"),shot_zone_basic != "Backcourt") %>% 
  ggplot() +
        stat_density2d(
          aes(x = loc_x/10,
              y = (loc_y + 50)/10,
              fill = stat(density/ max(density))),
          geom = "raster",
          contour = FALSE,
          interpolate = TRUE,
          n = 50
          ) +
  facet_wrap(~factor(combined_shot_type, levels =  c("Bank Shot", "Hook Shot"), labels = c("Tableritos", "Ganchos")), scales = "free") +
  geom_path(
    data = court_points,
    aes(x = x, y = y, group = desc),
    color = "white"
  )  +
  scale_fill_viridis_c(
      "Frecuencia de tiro",
      limits = c(0, 1),
      breaks = c(0, 1),
      labels = c("baja", "alta"),
      option = "magma",
      guide = guide_colorbar(barwidth = 8)
    )  +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    strip.text = element_text(size = 12),
    legend.position = "bottom"
  ) +
  coord_cartesian(expand = FALSE)
```

# Ideas
- En qué cuarto metía más puntos
- Qué tan bueno era cuando quedaban menos de 1 minuto




